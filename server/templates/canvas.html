<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap-3.3.7/css/bootstrap.min.css') }}">
    <title>Create Configuration</title>
    <script src="{{url_for('static', filename='js/jquery-3.3.1.min.js')}}"></script>
</head>
<body>
<div class="container-fluid">
    <form>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-default" role="button" onclick="click_remove_du('DUS41')">-
            </button>
            <button type="button" class="btn btn-default" role="button" disabled="disabled">DUS41</button>
            <button type="button" class="btn btn-default" role="button" onclick="click_add_du('DUS41')">+</button>
        </div>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-default" role="button" onclick="click_remove_du('DUS52')">-
            </button>
            <button type="button" class="btn btn-default" role="button" disabled="disabled">DUS52</button>
            <button type="button" class="btn btn-default" role="button" onclick="click_add_du('DUS52')">+</button>
        </div>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-default" role="button" onclick="click_remove_pimcu('PIMCU_P614')">
                -
            </button>
            <button type="button" class="btn btn-default" role="button" disabled="disabled">PIMCU_P614</button>
            <button type="button" class="btn btn-default" role="button" onclick="click_add_pimcu('PIMCU_P614')">+
            </button>
        </div>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-default" role="button" onclick="click_remove_xmu('XMU03')">-
            </button>
            <button type="button" class="btn btn-default" role="button" disabled="disabled">XMU03</button>
            <button type="button" class="btn btn-default" role="button" onclick="click_add_xmu('XMU03')">+</button>
        </div>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-default" role="button" onclick="click_remove_ru('RUS01B1')">-
            </button>
            <button type="button" class="btn btn-default" role="button" disabled="disabled">RUS01B1</button>
            <button type="button" class="btn btn-default" role="button" onclick="click_add_ru('RUS01B1')">+</button>
        </div>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-default" role="button" onclick="click_remove_ru('RRUS12mB13')">-
            </button>
            <button type="button" class="btn btn-default" role="button" disabled="disabled">RRUS12mB13</button>
            <button type="button" class="btn btn-default" role="button" onclick="click_add_ru('RRUS12mB13')">+
            </button>
        </div>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-default" role="button" onclick="click_remove_ru('RUS2212B03')">-
            </button>
            <button type="button" class="btn btn-default" role="button" disabled="disabled">RUS2212B03</button>
            <button type="button" class="btn btn-default" role="button" onclick="click_add_ru('RUS2212B03')">+
            </button>
        </div>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-default" role="button" onclick="click_remove_ru('IRU2242')">-
            </button>
            <button type="button" class="btn btn-default" role="button" disabled="disabled">IRU2242</button>
            <button type="button" class="btn btn-default" role="button" onclick="click_add_ru('IRU2242')">+</button>
        </div>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-default" role="button" onclick="click_remove_ru('RD2242')">-
            </button>
            <button type="button" class="btn btn-default" role="button" disabled="disabled">RD2242</button>
            <button type="button" class="btn btn-default" role="button" onclick="click_add_ru('RD2242')">+</button>
        </div>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-default" role="button" onclick="click_remove_ru('RRUS32B30')">-
            </button>
            <button type="button" class="btn btn-default" role="button" disabled="disabled">RRUS32B30</button>
            <button type="button" class="btn btn-default" role="button" onclick="click_add_ru('RRUS32B30')">+
            </button>
        </div>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-default" role="button" onclick="click_remove_ru('RU0208B1')">-
            </button>
            <button type="button" class="btn btn-default" role="button" disabled="disabled">RU0208B1</button>
            <button type="button" class="btn btn-default" role="button" onclick="click_add_ru('RU0208B1')">+
            </button>
        </div>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-default" role="button" onclick="click_remove_ru('RU2217B20')">-
            </button>
            <button type="button" class="btn btn-default" role="button" disabled="disabled">RU2217B20</button>
            <button type="button" class="btn btn-default" role="button" onclick="click_add_ru('RU2217B20')">+
            </button>
        </div>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-default" role="button" onclick="click_remove_ru('RU2217B01')">-
            </button>
            <button type="button" class="btn btn-default" role="button" disabled="disabled">RU2217B01</button>
            <button type="button" class="btn btn-default" role="button" onclick="click_add_ru('RU2217B01')">+
            </button>
        </div>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-default" role="button" onclick="click_remove_ru('RU2219B0A')">-
            </button>
            <button type="button" class="btn btn-default" role="button" disabled="disabled">RU2219B0A</button>
            <button type="button" class="btn btn-default" role="button" onclick="click_add_ru('RU2219B0A')">+
            </button>
        </div>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-default" role="button" onclick="click_remove_ru('RU4415B7')">-
            </button>
            <button type="button" class="btn btn-default" role="button" disabled="disabled">RU4415B7</button>
            <button type="button" class="btn btn-default" role="button" onclick="click_add_ru('RU4415B7')">+
            </button>
        </div>
		<button type="button" class="btn btn-primary" role="button" onclick="click_generate_config()">Generate</button>
    </form>
    <div id="divCanvas" style="overflow-x:auto;">
        <canvas style="cursor:pointer;" id="canvasMain" width="500" height="500">Current WebBrowser Doesn't Support
            Canvas
        </canvas>
    </div>
</div>
<script type="text/javascript">
    var UNIT_WIDTH = 100;
    var UNIT_HEIGHT = 160;
    var SPACE_UNIT_HORIZONTAL = 60;
    var SPACE_UNIT_VERTICAL = 30;
    var SPACE_UNIT_PORT = 5;
    var RU_MAX_NUM_TX_RX = {
        'RUS01B1':2,
        'RRUS12mB13':2,
        'RUS2212B03':2,
        'IRU2242':2,
        'RD2242':2,
        'RRUS32B30':4,
        'RU0208B1':2,
        'RU2217B20':2,
        'RU2217B01':2,
        'RU2219B0A':2,
        'RU4415B7':4
    }
    var dus = new Array();
    var pimcus = new Array();
    var xmus = new Array();
    var rus = new Array();
    var ports = {};
    var connects = new Array();
    var current_connection = {};
    var drawing_connect_flag = false;
	var hover_port = {};
	var hover_connect = {};
    var c = document.getElementById("canvasMain");
    c.addEventListener('click',function(ev){
        var x = 0;
        var y = 0;
        if (ev.layerX || ev.layerX == 0) {
            x = ev.layerX;
            y = ev.layerY;
        } else if (ev.offsetX || ev.offsetX == 0) {
            x = ev.offsetX;
            y = ev.offsetY;
        }
        if(!drawing_connect_flag) {
			var unit = hover_port['unit'];
			var port = hover_port['port'];
			var orientation = hover_port['orientation'];
			if(unit != undefined){
				drawing_connect_flag = true;
				current_connection['unit'] = hover_port['unit'];
				current_connection['port'] = hover_port['port'];
				current_connection['orientation'] = hover_port['orientation'];
			}
        } else {
            var port_orientation = hover_port['orientation'];
			if(port_orientation != undefined){
				drawing_connect_flag = false;
				if (current_connection['unit'] != hover_port['unit']) {
					var connection = {};
					connection['start_unit'] = current_connection['unit'];
					connection['start_port'] = current_connection['port'];
					connection['start_orientation'] = current_connection['orientation'];
					connection['end_unit'] = hover_port['unit'];
					connection['end_port'] = hover_port['port'];
					connection['end_orientation'] = hover_port['orientation'];
					connects.push(connection);
				}
				current_connection = {};
			} else {
				drawing_connect_flag = false;
				current_connection = {};
			}
        }
		if (hover_connect['start_unit'] != undefined){
			remove_connect_by_click();
		}
		draw_graph();
    },false);
    c.addEventListener('mousemove', function(ev){
        var x = 0;
        var y = 0;
        if (ev.layerX || ev.layerX == 0) {
            x = ev.layerX;
            y = ev.layerY;
        } else if (ev.offsetX || ev.offsetX == 0) {
            x = ev.offsetX;
            y = ev.offsetY;
        }
		if(drawing_connect_flag) {
			current_connection['end_x'] = x;
			current_connection['end_y'] = y;
		}
		if(!drawing_connect_flag) {
			get_connect_by_location(x,y);
		}
		get_port_by_location(x,y);
		draw_graph();
    },false);
	c.addEventListener('mouseout', function(ev){
		if(drawing_connect_flag) {
			drawing_connect_flag = false;
			current_connection = {};
			draw_graph();
		}
	},false);
    var ctx = c.getContext("2d");

    function click_add_du(type){
        dus.push(type)
        draw_graph();
    }

    function click_remove_du(type){
        var new_dus = new Array();
        var reverse_dus = dus.reverse();
        var remove_flag = false;
		var remove_id = 1;
        for(var du in reverse_dus){
            if (remove_flag == false) {
                if(reverse_dus[du] == type){
                    remove_flag = true;
                    continue;
                }
            }
			if(reverse_dus[du] == type){
				remove_id++;
			}
            new_dus.push(reverse_dus[du])
        }
		remove_connect_by_unit(type + "_" + remove_id);
        dus = new_dus.reverse();
        draw_graph();
    }

    function click_add_pimcu(type){
        pimcus.push(type)
        draw_graph();
    }

    function click_remove_pimcu(type){
        var new_pimcus = new Array();
        var reverse_pimcus = pimcus.reverse();
        var remove_flag = false;
		var remove_id = 1;
        for(var pimcu in reverse_pimcus){
            if (remove_flag == false) {
                if(reverse_pimcus[pimcu] == type){
                    remove_flag = true;
                    continue;
                }
            }
			if(reverse_pimcus[pimcu] == type){
				remove_id++;
			}
            new_pimcus.push(reverse_pimcus[pimcu])
        }
		remove_connect_by_unit(type + "_" + remove_id);
        pimcus = new_pimcus.reverse();
        draw_graph();
    }

    function click_add_xmu(type){
        xmus.push(type)
        draw_graph();
    }

    function click_remove_xmu(type){
        var new_xmus = new Array();
        var reverse_xmus = xmus.reverse();
        var remove_flag = false;
		var remove_id = 1;
        for(var xmu in reverse_xmus){
            if (remove_flag == false) {
                if(reverse_xmus[xmu] == type){
                    remove_flag = true;
                    continue;
                }
            }
			if(reverse_xmus[xmu] == type){
				remove_id++;
			}
            new_xmus.push(reverse_xmus[xmu])
        }
		remove_connect_by_unit(type + "_" + remove_id);
        xmus = new_xmus.reverse();
        draw_graph();
    }

    function click_add_ru(type){
        rus.push(type)
        draw_graph();
    }

    function click_remove_ru(type){
        var new_rus = new Array();
        var reverse_rus = rus.reverse();
        var remove_flag = false;
		var remove_id = 1;
        for(var ru in reverse_rus){
            if (remove_flag == false) {
                if(reverse_rus[ru] == type){
                    remove_flag = true;
                    continue;
                }
            }
			if(reverse_rus[ru] == type){
				remove_id++;
			}
            new_rus.push(reverse_rus[ru])
        }
		remove_connect_by_unit(type + "_" + remove_id);
        rus = new_rus.reverse();
        draw_graph();
    }

    function draw_graph(){
		ports = {}
        set_canvas_dimension();
		ctx.beginPath();
        draw_dus();
        draw_pimcus();
        draw_xmus();
        draw_rus();
		draw_hover_port();
		ctx.stroke();
		draw_connects();
		draw_hover_connect();
		draw_current_connect();
    }

    function draw_dus(){
        exist = {}
        for(var i in dus){
            var prev_index = exist[dus[i]];
            if(prev_index == undefined){
                exist[dus[i]] = 1;
            } else {
                exist[dus[i]] = prev_index + 1;
            }
            var x = SPACE_UNIT_HORIZONTAL;
            var y = SPACE_UNIT_VERTICAL + (SPACE_UNIT_VERTICAL + UNIT_HEIGHT) * i;
            ctx.rect(x,y,UNIT_WIDTH,UNIT_HEIGHT);
            ctx.fillText(dus[i] + '_' + exist[dus[i]],x + UNIT_WIDTH / 2 - (dus[i].length) * 4,y + UNIT_HEIGHT / 2);

            //Left Port
            ctx.fillText('IDL_A',x - SPACE_UNIT_PORT - 26,y + UNIT_HEIGHT / 2);
			ports[dus[i] + '_' + exist[dus[i]] + ',IDL_A,left'] = (x - SPACE_UNIT_PORT - 26) + ',' + (y + UNIT_HEIGHT / 2);
            //Right Port
            var right_ports = ['A','B','C','D','E','F']
            for(var j in right_ports){
                ctx.fillText(right_ports[j],x + UNIT_WIDTH + SPACE_UNIT_PORT,y + (UNIT_HEIGHT / 6) * j + 15);
				ports[dus[i] + '_' + exist[dus[i]] + ',' + right_ports[j] + ',right'] = (x + UNIT_WIDTH + SPACE_UNIT_PORT) + ',' + (y + (UNIT_HEIGHT / 6) * j + 15)
            }
        }
    }

    function draw_pimcus(){
        exist = {}
        for(var i in pimcus){
            var prev_index = exist[pimcus[i]];
            if(prev_index == undefined){
                exist[pimcus[i]] = 1;
            } else {
                exist[pimcus[i]] = prev_index + 1;
            }
            var horizontal_space = 0;
            if(dus.length > 0) {
                horizontal_space = SPACE_UNIT_HORIZONTAL + UNIT_WIDTH + SPACE_UNIT_HORIZONTAL;
            }
            var x = horizontal_space + SPACE_UNIT_HORIZONTAL;
            var y = SPACE_UNIT_VERTICAL + (SPACE_UNIT_VERTICAL + UNIT_HEIGHT) * i;
            ctx.rect(x,y,UNIT_WIDTH,UNIT_HEIGHT);
            ctx.fillText(pimcus[i] + '_' + exist[pimcus[i]],x + UNIT_WIDTH / 2 - (pimcus[i].length) * 4,y + UNIT_HEIGHT / 2);

            //Left PORT
            var left_ports = ['A','B','C','D','E','F']
            for(var j in left_ports){
                ctx.fillText('BB_' + left_ports[j],x - SPACE_UNIT_PORT - 26,y + (UNIT_HEIGHT / 6) * j + 15);
				ports[pimcus[i] + '_' + exist[pimcus[i]] + ',BB_' + left_ports[j] + ',left'] = (x - SPACE_UNIT_PORT - 26) + ',' + (y + (UNIT_HEIGHT / 6) * j + 15);
            }
            //Right Port
            var right_ports = ['A','B','C','D','E','F']
            for(var j in right_ports){
                ctx.fillText('RU_' + right_ports[j],x + UNIT_WIDTH + SPACE_UNIT_PORT,y + (UNIT_HEIGHT / 6) * j + 15);
				ports[pimcus[i] + '_' + exist[pimcus[i]] + ',RU_' + right_ports[j] + ',right'] = (x + UNIT_WIDTH + SPACE_UNIT_PORT) + ',' + (y + (UNIT_HEIGHT / 6) * j + 15);
            }
			//IPL Port
			var ipl_ports = ['A','B'];
			for(var j in ipl_ports){
				px = 0;
				py = 0;
				orientation = 'down';
				if(i % 2 == 1){
					px = x + (UNIT_WIDTH / 2) * j + 15;
					py = y + 12;
					orientation = 'up';
				}else {
					px = x + (UNIT_WIDTH / 2) * j + 15;
					py = y + UNIT_HEIGHT - 8;
					orientation = 'down';
				}
                ctx.fillText('IPL_' + ipl_ports[j],px,py);
				ports[pimcus[i] + '_' + exist[pimcus[i]] + ',IPL_' + ipl_ports[j] + ',' + orientation] = px + ',' + py;
            }
        }
    }

    function draw_xmus(){
        exist = {}
        for(var i in xmus){
            var prev_index = exist[xmus[i]];
            if(prev_index == undefined){
                exist[xmus[i]] = 1;
            } else {
                exist[xmus[i]] = prev_index + 1;
            }
            var horizontal_space = 0;
            if(dus.length > 0) {
                horizontal_space += SPACE_UNIT_HORIZONTAL + UNIT_WIDTH + SPACE_UNIT_HORIZONTAL;
            }
            if(pimcus.length > 0) {
                horizontal_space += SPACE_UNIT_HORIZONTAL + UNIT_WIDTH + SPACE_UNIT_HORIZONTAL;
            }
            var x = horizontal_space + SPACE_UNIT_HORIZONTAL;
            var y = SPACE_UNIT_VERTICAL + (SPACE_UNIT_VERTICAL + UNIT_HEIGHT) * i;
            ctx.rect(x,y,UNIT_WIDTH,UNIT_HEIGHT);
            ctx.fillText(xmus[i] + '_' + exist[xmus[i]],x + UNIT_WIDTH / 2 - (xmus[i].length) * 4,y + UNIT_HEIGHT / 2);

            //Left PORT
            var left_ports = ['1','2','3']
            for(var j in left_ports){
                ctx.fillText(left_ports[j],x - SPACE_UNIT_PORT - 5,y + (UNIT_HEIGHT / 3) * j + 30);
				ports[xmus[i] + '_' + exist[xmus[i]] + ',' + left_ports[j] + ',left'] = (x - SPACE_UNIT_PORT - 5) + ',' + (y + (UNIT_HEIGHT / 3) * j + 30);
            }
            //Right Port
            var right_ports = ['4','5','6','7','9','10','11','12','13','14','15','16']
            for(var j in right_ports){
                ctx.fillText(right_ports[j],x + UNIT_WIDTH + SPACE_UNIT_PORT,y + (UNIT_HEIGHT / 12) * j + 10);
				ports[xmus[i] + '_' + exist[xmus[i]] + ',' + right_ports[j] + ',right'] = (x + UNIT_WIDTH + SPACE_UNIT_PORT) + ',' + (y + (UNIT_HEIGHT / 12) * j + 10);
            }
        }
    }

    function draw_rus(){
        exist = {}
        for(var i in rus){
            var prev_index = exist[rus[i]];
            if(prev_index == undefined){
                exist[rus[i]] = 1;
            } else {
                exist[rus[i]] = prev_index + 1;
            }
            var horizontal_space = 0;
            if(dus.length > 0) {
                horizontal_space += SPACE_UNIT_HORIZONTAL + UNIT_WIDTH + SPACE_UNIT_HORIZONTAL;
            }
            if(pimcus.length > 0) {
                horizontal_space += SPACE_UNIT_HORIZONTAL + UNIT_WIDTH + SPACE_UNIT_HORIZONTAL;
            }
            if(xmus.length > 0){
                horizontal_space += SPACE_UNIT_HORIZONTAL + UNIT_WIDTH + SPACE_UNIT_HORIZONTAL;
            }
            var x = horizontal_space + SPACE_UNIT_HORIZONTAL;
            var y = SPACE_UNIT_VERTICAL + (SPACE_UNIT_VERTICAL + UNIT_HEIGHT) * i;
            ctx.rect(x,y,UNIT_WIDTH,UNIT_HEIGHT);
            ctx.fillText(rus[i] + '_' + exist[rus[i]],x + UNIT_WIDTH / 2 - (rus[i].length) * 4,y + UNIT_HEIGHT / 2);

            //Left PORT
            var left_ports = ['1','2']
            for(var j in left_ports){
                ctx.fillText('DATA_'+left_ports[j],x - SPACE_UNIT_PORT - 35,y + (UNIT_HEIGHT / 2) * j + 35);
				ports[rus[i] + '_' + exist[rus[i]] + ',DATA_' + left_ports[j] + ',left'] = (x - SPACE_UNIT_PORT - 35) + ',' + (y + (UNIT_HEIGHT / 2) * j + 35);
            }
            //Right Port
            var right_ports = ['A','B','C','D'];
            var right_ports_num = RU_MAX_NUM_TX_RX[rus[i]];
            for(var j=0;j<right_ports_num;j++){
				var right_port_x = x + UNIT_WIDTH + SPACE_UNIT_PORT;
				var right_port_y = y + (UNIT_HEIGHT / right_ports_num) * j + 80 / right_ports_num;
                ctx.fillText(right_ports[j],right_port_x,right_port_y);

				//draw tma
				var tma_x = x + UNIT_WIDTH + SPACE_UNIT_PORT+ SPACE_UNIT_HORIZONTAL;
				var tma_y = y + (UNIT_HEIGHT / right_ports_num) * j + 80 / right_ports_num - (UNIT_HEIGHT / (right_ports_num + 1))/2;
				var tma_w = UNIT_WIDTH / 2;
				var tma_h = UNIT_HEIGHT / (right_ports_num + 1);

				ctx.moveTo(right_port_x + SPACE_UNIT_PORT + 6,right_port_y - 3);
				ctx.lineTo(tma_x - SPACE_UNIT_PORT - 22,right_port_y - 3);

				ctx.rect(tma_x,tma_y,tma_w,tma_h);
				ctx.fillText('TMA_' + (j+1),tma_x + 10,tma_y+tma_h/2);
				ctx.fillText('OUT',tma_x - SPACE_UNIT_PORT - 20,right_port_y);
				ctx.fillText('IN',tma_x + tma_w + SPACE_UNIT_PORT,right_port_y);
            }

			//SEF
			var sef_x = x + UNIT_WIDTH + SPACE_UNIT_PORT+ SPACE_UNIT_HORIZONTAL + UNIT_WIDTH / 2 + SPACE_UNIT_HORIZONTAL;
			ctx.rect(sef_x,y,UNIT_WIDTH * 2,UNIT_HEIGHT);
			var sef_text_x = sef_x + UNIT_WIDTH * 2 - 12;
			var sef_text_y = y + UNIT_HEIGHT / 2 - 10;
			ctx.fillText('S',sef_text_x,sef_text_y);
			ctx.fillText('E',sef_text_x,sef_text_y + 10);
			ctx.fillText('F',sef_text_x,sef_text_y + 20);
			ctx.fillText('' + (parseInt(i) + 1),sef_text_x,sef_text_y + 30);
			ctx.fillText('1',sef_text_x + 12 + SPACE_UNIT_PORT,sef_text_y + 10);

			//AUG
			var aug_x = sef_x + UNIT_WIDTH / 4;
			ctx.rect(aug_x,y - 10,UNIT_WIDTH * 3 / 2 ,UNIT_HEIGHT + 20);

			//AU,ASU
			var au_x = aug_x + UNIT_WIDTH / 4;
			ctx.rect(au_x,y,UNIT_WIDTH,UNIT_HEIGHT);
			var au_text_x = au_x + UNIT_WIDTH / 2 - 20;
			var au_text_y = y + UNIT_HEIGHT / 2 - 3;
			ctx.fillText('AU-1',au_text_x,au_text_y);
			ctx.fillText('AUG-' + (parseInt(i) + 1),au_text_x,au_text_y - 10);
			ctx.fillText('ASU-1',au_text_x,au_text_y + 10);
			for(var j=0;j<right_ports_num;j++){
				var in_y = y + (UNIT_HEIGHT / right_ports_num) * j + 80 / right_ports_num;
				ctx.fillText('' + (parseInt(j) + 1),au_x - 10,in_y);
				var tma_x = x + UNIT_WIDTH + SPACE_UNIT_PORT+ SPACE_UNIT_HORIZONTAL + UNIT_WIDTH / 2 + SPACE_UNIT_PORT;
				ctx.moveTo(tma_x + SPACE_UNIT_PORT + 6,in_y - 3);
				ctx.lineTo(au_x - SPACE_UNIT_PORT - 6,in_y - 3);
			}

			//CarrierGroup
			var cg_x = sef_x + UNIT_WIDTH * 2 + SPACE_UNIT_HORIZONTAL;
			ctx.rect(cg_x,y,UNIT_WIDTH,UNIT_HEIGHT);
			ctx.fillText('CarrierGroup-' + (parseInt(i) + 1),cg_x + UNIT_WIDTH / 2 - 30,y + UNIT_HEIGHT / 2);
			ctx.fillText('1',cg_x - SPACE_UNIT_PORT - 6,y + UNIT_HEIGHT / 2);

			ctx.moveTo(sef_text_x + SPACE_UNIT_PORT + 18,y + UNIT_HEIGHT / 2 - 3);
			ctx.lineTo(cg_x - SPACE_UNIT_PORT - 6,y + UNIT_HEIGHT / 2 - 3);
        }
    }

	function draw_hover_port(){
		var unit = hover_port['unit'];
		var port = hover_port['port'];
		var orientation = hover_port['orientation'];
		if(unit != undefined){
			var point = ports[unit+","+port+","+orientation].split(',');
			var px_1 = parseInt(point[0]) - 3;
			var py_1 = parseInt(point[1]) - 10;
			ctx.rect(px_1,py_1,port.length * 6 + 6,14);
		}
	}

	function draw_hover_connect(){
		if(hover_connect['start_unit'] != undefined){
			var point1 = get_port_draw_point(hover_connect['start_unit'],hover_connect['start_port'],hover_connect['start_orientation']);
			var point2 = get_port_draw_point(hover_connect['end_unit'],hover_connect['end_port'],hover_connect['end_orientation']);
			ctx.beginPath();
			ctx.strokeStyle = '#ff0000';
			ctx.lineWidth = 2;
			ctx.arc(point1[0]+(point2[0]-point1[0])/2,point1[1]+(point2[1]-point1[1])/2,5,0,2*Math.PI);
			ctx.stroke();
		}
	}

	function draw_connects(){
		for(var conn in connects){
			var connect = connects[conn];
			var point1 = get_port_draw_point(connect['start_unit'],connect['start_port'],connect['start_orientation'])
			var point2 = get_port_draw_point(connect['end_unit'],connect['end_port'],connect['end_orientation'])
			ctx.beginPath();
			ctx.strokeStyle = '#00ff00';
			ctx.lineWidth = 2;
			ctx.moveTo(point1[0],point1[1]);
			ctx.lineTo(point2[0],point2[1]);
			ctx.stroke();
			ctx.beginPath();
		}
	}

	function draw_current_connect(){
		if(drawing_connect_flag) {
			var unit = current_connection['unit'];
			var port = current_connection['port'];
			var orientation = current_connection['orientation'];
			var point = get_port_draw_point(unit,port,orientation)
			ctx.beginPath();
			ctx.strokeStyle = '#0000ff';
			ctx.arc(point[0],point[1],3,0,2*Math.PI);
			ctx.stroke();
			ctx.beginPath();
			ctx.strokeStyle = '#0000ff';
			ctx.lineWidth = 2;
			ctx.moveTo(point[0],point[1]);
			ctx.lineTo(current_connection['end_x'],current_connection['end_y']);
			ctx.stroke();
		}
	}

    function set_canvas_dimension(){
        total = Math.max(dus.length,pimcus.length,xmus.length,rus.length);
        var min_width = $("#divCanvas").width();
		var draw_width = SPACE_UNIT_HORIZONTAL;
		if (dus.length > 0){
			draw_width += UNIT_WIDTH + SPACE_UNIT_HORIZONTAL * 2;
		}
		if (pimcus.length > 0){
			draw_width += UNIT_WIDTH + SPACE_UNIT_HORIZONTAL * 2;
		}
		if (xmus.length > 0){
			draw_width += UNIT_WIDTH + SPACE_UNIT_HORIZONTAL * 2;
		}
		if (rus.length > 0){
			draw_width += UNIT_WIDTH * 4 + SPACE_UNIT_HORIZONTAL * 4;
		}
		if (draw_width < min_width){
			draw_width = min_width;
		}
		c.width = draw_width;
        c.height = (SPACE_UNIT_VERTICAL + UNIT_HEIGHT) * total + SPACE_UNIT_VERTICAL;
    }

	function get_port_by_location(x,y){
		hover_port = {};
		for(var p in ports){
			var upo = p.split(',');
			var unit = upo[0];
			var port = upo[1];
			var orientation = upo[2];
			var point = ports[p].split(',');
			var px_1 = parseInt(point[0]) - 3;
			var py_1 = parseInt(point[1]) - 10;
			var px_2 = px_1 + port.length * 6 + 6;
			var py_2 = py_1 + 14;
			if (x >= px_1 && x <= px_2 && y >= py_1 && y <= py_2) {
				hover_port['unit'] = unit;
				hover_port['port'] = port;
				hover_port['orientation'] = orientation;
				break;
			}
		}
	}

	function get_connect_by_location(x,y){
		hover_connect = {};
		for(var conn in connects){
			var connect = connects[conn];
			var point1 = get_port_draw_point(connect['start_unit'],connect['start_port'],connect['start_orientation'])
			var point2 = get_port_draw_point(connect['end_unit'],connect['end_port'],connect['end_orientation'])
			var center_x = point1[0]+(point2[0]-point1[0])/2;
			var center_y = point1[1]+(point2[1]-point1[1])/2;
			var px_1 = center_x - 5;
			var py_1 = center_y - 5;
			var px_2 = center_x + 5;;
			var py_2 = center_y + 5;
			if (x >= px_1 && x <= px_2 && y >= py_1 && y <= py_2) {
				hover_connect['start_unit'] = connect['start_unit'];
				hover_connect['start_port'] = connect['start_port'];
				hover_connect['start_orientation'] = connect['start_orientation'];
				hover_connect['end_unit'] = connect['end_unit'];
				hover_connect['end_port'] = connect['end_port'];
				hover_connect['end_orientation'] = connect['end_orientation'];
				break;
			}
		}
	}

	function remove_connect_by_unit(unit){
		var new_connects = new Array();
		for (var c in connects) {
			var start_unit = connects[c]['start_unit'];
			var end_unit = connects[c]['end_unit'];
			if (start_unit == unit || end_unit == unit) {
				continue;
			}
			new_connects.push(connects[c]);
		}
		connects = new_connects;
	}

	function remove_connect_by_click(){
		var new_connects = new Array();
		for (var c in connects) {
			var start_unit = connects[c]['start_unit'];
			var start_point = connects[c]['start_port'];
			var end_unit = connects[c]['end_unit'];
			var end_point = connects[c]['end_port'];
			if (start_unit == hover_connect['start_unit'] && start_point == hover_connect['start_port'] && end_unit == hover_connect['end_unit'] && end_point == hover_connect['end_port']) {
				hover_connect = {};
				continue;
			}
			new_connects.push(connects[c]);
		}
		connects = new_connects;
	}

	function get_port_draw_point(unit,port,orientation){
		var point = ports[unit+","+port+","+orientation].split(',');
		var x1 = parseInt(point[0]) - 3;
		var y1 = parseInt(point[1]) - 10;
		var x2 = x1 + port.length * 6 + 6;
		var y2 = y1 + 14;
		var x = 0;
		var y = 0;
		if (orientation == 'left'){
			x = x1 - 5;
			y = y1 + (y2 - y1) / 2;
		} else if(orientation == 'right') {
			x = x2 + 5;
			y = y1 + (y2 - y1) / 2;
		} else if(orientation == 'up') {
			x = x1 += (x2 - x1) / 2;
			y = y1 - 5;
		} else if(orientation == 'down') {
			x = x1 += (x2 - x1) / 2;
			y = y2 + 5;
		}
		return [x,y]
	}
	
	function click_generate_config(){
		alert(1);
	}
</script>
</body>
</html>